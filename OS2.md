# OS 2章
## ハードウェアの概要
- プロセッサと主記憶装置はメモリバスで接続されている。キーボードなどのデバイスはデバイスドライバを経由して接続されている。また、SSDなどはPCI expressで接続されている。

## プロセッサ
- プロセッサにはレジスタと呼ばれる小規模なメモリを有している。レジスタは演算対象となるデータや次の命令を格納する。各社のプロセッサによって持ってるレジスタは変わる。
命令は機械語で記述されているが、バイト列で示されると分かりずらいので、ニーモニックが使用される(MOV JMPとかね)。

- 命令の内容をオペコード、命令の対象をオペランドという。
ADD 3
オペコード　オペランド

- プロセッサは機械語プログラムを逐次実行する。プロセッサにはプログラムカウンターというレジスタがあり、そこに次に実行する命令のアドレスを格納する。プロセッサはそこから命令をフェッチし、実行する。プログラムカウンタは次の命令を格納する。
- プロセッサによりレジスタ、解読可能な命令は異なり、それらをまとめたものを命令セットアーキテクチャーという。

- プロセッサが命令を逐次実行していく流れをハードウェアスレッドという。昔は、一度に１つのハードウェアスレッドしか実行できなかったが、現在は複数のプロセッサコアを持ち、複数のハードウェアスレッドを実行できる。これをマルチコアプロセッサという。

## スタック
- 機械語プログラムには必要なデータを格納するために、スタックが用意されている(スタックフレーム)。プロセッサにはスタックポインタというレジスタが搭載されていて、最後にpushしたデータが格納されている。

## 動作モード
- OSには、カーネルモードとユーザーモードがある。カーネルモードではOSのすべての機能を使える。ユーザーモードでは一部(特権命令など)制限され、特権違反例外が返される。

## 割り込み
- 割り込みの手順を以下に示す。
- プロセスをカーネルモードに切り替え、レジスタの値をカーネルスタックに格納する。
- 割り込みハンドラーを起動する。
- 割り込みハンドラーの最後で、割り込みから復帰する命令を実行して、元のプロセスに戻る。

### 外部割り込み
- プロセッサ外部のデバイスにおいてなんらかの事象が発生したことをプロセッサに通知する。
- キーボードのキーが押されたとか、離されたとか。これ打ってる時割り込みまくり。
- プロセッサには、外部割り込み要求を受け付けるための割り込み信号線(IRQ)がつながっている。割り込まれると割り込みハンドラが起動する。割り込みハンドラは必要に応じて割り込みの内容を調べる。

### 内部割り込み
- プログラムの実行に伴いプロセッサ内で発生する割り込みのこと。
- ソフトウェア割り込みと例外の２つがある。
- ソフトウェア割り込みはユーザーモードからカーエルモードへの切り替えに使用される。例外はゼロ除算とか。

### 割り込みベクタテーブル
- 割り込みには多様な種類があり、それに応じて処理方法を変える必要がある。プロセッサは割り込みハンドラを複数定義できるようになっている。その割り込みの識別番号と割り込みハンドラのベクトルを割り込みベクタテーブルという。割り込みベクタテーブルを参照して対応する割り込みハンドラを起動する。割り込みベクタテーブルはコンピュータ起動時、OS起動時に初期化される。

##　マルチプロセッサ
- 複数のプロセッサを搭載し、複数のハードウェアスレッドを実行するシステムをマルチプロセッサという。マルチコアプロセッサもマルチプロセッサの一種とみなせる。
### SMP 
- マルチプロセッサの一種。すべてのプロセッサが同じ種類であって、メモリを共有している。構造上、すべてのプロセッサによるメインメモリ参照時間は同じである。
### NUMA 
- プロセッサごとにローカルメモリを有していて、リモートメモリ(他のプロセッサまたはプロセッサグループのローカルメモリ)よりもアクセスが高速である。プロセッサが参照するメモリの位置によって参照時間が変動する。

- 最近はNUMAが主流らしいよ。

## メモリ
- メインメモリは、仮想メモリと区別をつけるために物理メモリとも呼ばれる。また、プロセッサが参照できる物理メモリの範囲を物理メモリ空間という。メインメモリはRAMとROMで構成される。
### RAM
- RAMは書き込みが可能だが、電源を消すと消える(揮発性)。RAMにはDRAMとSRAMがあり、DRAMはコンデンサの蓄電により記憶する。放電により記憶が消失することを防ぐために、定期的に電圧チャージ(リフレッシュ)が行われる。SRAMはそんなことしなくていいけど、デカくて高い。
- ROMは、、読む専用のメモリだが電源を消しても消えない。

- RAMやROMは物理メモリ空間に配置される。

## キャッシュメモリ
- プロセッサのレジスタ参照速度は1ns程度。対して、メインメモリ参照速度は100ns程度で非常に低速である。メインメモリ参照待ちによるプロセスの停止をメモリストールという。メモリストールを回避するため、キャッシュメモリが用意されている。
- みんな知っている通り、L1キャッシュ参照の速度は0.5nsくらいで、L2キャッシュは7nsくらいのイメージ、L3は？わかんね。まぁ80nsくらいじゃない？
- 一回参照されたデータはまた参照される傾向にあるという、参照の局所性が念頭に置かれてOSは設計される。L3でヒットしたデータはL1にまで引き上げられ、参照されていなかったデータがL1から追い出される。

## メモリーヒエラルキー
- レジスタ(本には1nsってあるけど、0.5ns以下だと思う)、L1キャッシュ(0.5ns)、L2キャッシュ(7ns)、L3(80ns)、


















