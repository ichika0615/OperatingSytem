# OS 4章
## メモリ管理
- プログラムを実行するには、補助記憶装置からメインメモリにプログラムを持ってきてメモリ空間に割り当て、かつスタックも用意する必要がある。マルチプロセスOSでは、プロセスをメインメモリに割り当てて、終了次第メモリを解放する必要がある。

### 物理記憶ベースのメモリ管理
#### 固定区画方式
- メインメモリをあらかじめいくつかの区画に分け、１つをカーネル用、残りをアプリケーションプログラム用に割り当てる。アプリケーションプログラム用の区画が１つであるものを単一区画方式、複数あることを多重区画方式という。単一区画方式はシングルタスクOSで、多重区画方式はマルチタスクOSで使用される。プロセスが要求するメモリの量は異なるので、１つのプロセスに対して複数の区画が使用され。そこで、メモリ内部でプロセス実行に使用されない「余りの」メモリが出てきて、しまい、それらを有効に使うことはできない。これを内部断片化という。

- 単一区画方式ではプログラムは必ず同じアドレスに配置されるので、機械語プログラムでアドレスを直接参照しても良い。
- 複数のプログラムがある時は、どこに何があるかわからないから、参照できない。
- 

#### 可変区画方式
- 区画のサイズを自由に変える方式。物理メモリ上の連続空間を細分化して、、使用中区画、または空き区画として利用する。
- 飛び飛びの空き区画を一度に使用するようなことはしない。
- ユーザプログラム用の物理メモリ上の領域を大きな１つの空き区画とする。プロセス開始時にh、あ空き区画のいくつかを割り当てて、あまりは空き区画とする。隣接する空き区画はマージ。これを繰り返すことで、小さな空き区画が飛び飛びに生じて、大きなプロセスを実行することができなくなる。これを外部断片化という。これは動的メモリ割り当てである。

##### 固定区画方式でも、可変区画方式でも断片化が生じ、メモリ使用率を下げてしまう。

### メモリコンパクション
- 可変区画方式における外部断片化を解決するために、使用中区画と空き区画を全てまとめて、空き区画が飛ぶことを防ぐ。これには多くのメモリーコピーを要し、その間はプロセスを停止する必要があり、プロセスから見たアドレスがかわらないようにする必要がある、などがある。

### スワッピング
- マルチプログラミング環境、マルチプロセス環境で、長期間長期間プロセスが待ち状態にある時、そのプロセスが使用している全てのメモリを補助記憶装置に退避させて(スワップアウト)プロセッサ利用効率を上げることができる。これをスワッピングという。逆に、対比させたプロセスをメインメモリに復帰させることをスワップインという。中期スケジューラというプログラムがスワップアウト、スワップインするプログラムを決定する。

### 動的メモリ割り当て
- 必要に応じてメモリ領域を確保したり解放したりすることを動的メモリ割り当てという。プロセスのヒープ領域や、カーネルヒープ領域など、様々な場面で動的にメモリが割り当てられる。

#### シーケンシャルフィットアルゴリズム
- 割り当てに適したメモリ領域を見つけるために、メモリプール内の空き領域を操作するアルゴリズムをいう。空き区間は双方向連結リストで管理する(空き区画自体にポインターが置かれる)。そうさして要求メモリ量以上の空き区画が見つかったら必要分だけ切り取って、残りは空き区画とする。また、割り当てが解放されて空き区画となったら隣の空き区画とマージする。
空き区画を探すアルゴリズムはいくつかある。
- ファーストフィット：　空き区画のリストを最初から辿る。
- ベストフィット：　空き区画の中で、最も残りの区画が小さくなる区画を探る。400と500のメモリがあって、要求が300なら400が選ばれる。
- ワーストフィット：　残りの区画が最も大きくなる区画を探す。400と500のメモリがあって、要求が300なら500が選ばれる。

#### バディシステム
- バイナリバディシステムなどの、いくつかのバリエーションがある。
- メモリを次々にに分割していって(等分されたされた２つのメモリーをバディという)、要求メモリーと等しいまたはそれ以上のものが出てきたら、それを割り当てる。
- つまり、1MBのメモリプールがあって、要求が　100KBなら、1MBを二分して、512KB、二分して256KB、二分して128KBとなり、これを割り当てる。外部断片化がおきずらく(????)、高速で割り当てが行われるが、内部断片化の問題は残っている。
- malocで守りが足りないならOS呼び出す。
- 最初に2MBあるとする。これを128KB欲しかったら、

## 仮想記憶
- プロセスが使用するアドレスと実際の物理アドレスを分離することで、メモリを仮想化する技術である。プロセスに対して、仮想アドレス空間を割り当てる。プロセスから見えるアドレスは物理アドレスではなく仮想アドレスである。仮想アドレスは仮想アドレスは物理アドレスに変換されてアクセスされる。
- 各プロセスに対して連続したアドレス空間を提供できる。
- C言語とかなら、リストが一個の塊みたいに見えてる。
- ４KB単位でバラバラでも困らない。
- 各プロセスのアドレス空間を分離することで、互いに隔離させてシステムの安定性を高める。
- 物理メモリ以上のメモリを利用できる。

- 仮想アドレスはMMUによって物理アドレスに動的に変換される。
- 仮想アドレスと物理アドレスをバイト単位で行うわけにはいかないで、セグメント方式、またはページング方式のいずれかが使われる。
- セグメント方式は、

### ページング方式
- 仮想アドレスと物理アドレスをページサイズに分割する。ページサイズは4KBが一般的である。
- 仮想アドレス空間オブロックをページ（仮想ページ）という。また、物理アドレス空間のそれを物理ページ(ページフレーム)という。
それぞれのページはページ番号で識別する。仮想アドレスの上位がページ番号、下位がページ内オフセット(先頭から何バイト目かを示す)という。物理ページも物理ページ番号で識別する。

- アドレス変換は、ページを物理ページに対応つける(mapする)ことで実現される。物理メモリは連続である必要がなく、外部断片化が起きない。

#### ページテーブル
- 仮想アドレスから物理アドレスへの変換は、ページテーブルを用いて行われる。ページテーブルの要素をページテーブルエントリーという。
- 多段ページテーブル

### 仮想アドレス空間
- 仮想アドレス空間は、一般的に低位領域をユーザープロセス、高位領域をカーネル用とする。前者をユーザー空間、後者をカーネル空間という。コンテキストスイッチでは、ユーザー空間なだけが入れ替わるようにする。
- ユーザー空間とカーネル空間は同じ仮想アドレスにあるが、カーネルはいずれの領域もアクセスできる。
- 仮想アドレスの0番地を含むページは読み書き禁止とする。nullpointerを使うらしい。
- 一般にテキスト領域はプロセスにより書き込まれることはない。そのため、テキスト空間は書き込み禁止とする。同一プログラムが複数回動作するときに物理メモリを共有できる。(??????)
- データ領域やスタック領域を機械語プロラグムとして実行できないようにする。

### デマンドページング
- 実行ファイルの全てをメモリにロードするのは非効率的である。事項ファイルは一度に全部実行されることはなく、全部ロードすると無駄になる。デマンドページングは必要に応じてプロセスに物理ページを割り当てる方法である。
- プロセス生成時にアドレス空間は用意する。しかし、物理ページは割り当てない。
- プロセスが物理ページの割り当てられてない仮想アドレスにアクセスするとページフォールトが発生してカーネルに制御が映る。
- カーネルは仮想アドレスがプロセスからのアクセスが許容朝れている範囲内ならそのページに物理ページを割り当て、プロセスの実行に戻る。
- デマンドページングはプロセスに対して透過的。
- 物理ページが不足すると、スワップ両機に退避させて必要なものに割り当てる。

#### ページフォルトハンドラ
- デマンドページングはあそうアドレスは割り当てるが、物理アドレスは割り当てない。
- 仮想アドレスvを取得する。
- もしvが無効なら強制終了、有効なら物理メモリを割り当てる。しばらく使用されないであろう物理ページを選ぶ。その物理ページを参照しているページテーブルエントリを0にしてアドレス変換を無効にする。書き込みがあるならスワップ領域に対比させて、空き物理ページとする。
- 確保した物理ページの内容を初期化する。vをページインする。s

### ページ置換アルゴリズム
- 当面使わないであろう物理ページを見つけるアルゴリズム。選択されたページを犠牲ページという。ページ置換アルゴリズムでは、ページフォールと率が低いことが求められる。
- 参照の局所性(短い時間の間にプロセスが参照するメモリアドレスは一般的に狭い領域に限定される健康がある)より、最近参照されたページは近いうちにまた参照される確率が高いので、最近参照されていないページを選択する。
#### OPT 
- これから最も長期間使用されないページをvictimizeする。これは一番ページフォールト率が低いことが証明されている。未来、どのページが参照されるのかわかっている必要があるので、実際はむずかしい。
#### LRU 
- 

## 動的リンク
- 仮想メモリの応用の１つ。
- 静的リンク
